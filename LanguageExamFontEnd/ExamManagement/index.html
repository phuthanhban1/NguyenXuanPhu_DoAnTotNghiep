<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω k·ª≥ thi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/assets/css/ExamManagement/index.css">
    <link rel="stylesheet" href="/assets/css/ExamManagement/sidebar.css">

    <!-- Bootstrap Datepicker JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/js/bootstrap-datepicker.min.js"></script>

<!-- Ng√¥n ng·ªØ ti·∫øng Vi·ªát cho datepicker -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.10.0/locales/bootstrap-datepicker.vi.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<style>
    .error {
      color: #dc3545 !important;
      font-size: 0.875rem !important;
      margin-top: 5px !important;
      display: block !important;
    }
    .valid {
      border-color: #28a745 !important;
    }
    .invalid {
      border-color: #dc3545 !important;
    }
   
</style>
<body>
    <div class="header-common">
        <script type="module">
            import {genHeader} from '/assets/js/library.js';
            genHeader($('.header-common'))
        </script>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="liveToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Th√¥ng b√°o</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <!-- Confirm Delete Modal -->
    <div class="modal fade" id="confirmDeleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">X√°c nh·∫≠n x√≥a</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a k·ª≥ thi n√†y?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">X√≥a</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h4 class="mb-0">Qu·∫£n l√Ω k·ª≥ thi</h4>
        </div>
        <ul class="sidebar-menu">
            <li><a href="index.html" class="active"><i class="fas fa-chart-line"></i>T·ªïng quan</a></li>
            <li><a href="room.html"><i class="fas fa-door-open"></i>Ph√≤ng thi</a></li>
        </ul>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1">T·ªïng quan k·ª≥ thi</h2>
                <p class="text-muted mb-0">Th·ªëng k√™ v√† qu·∫£n l√Ω k·ª≥ thi</p>
            </div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addExamModal">
                <i class="fas fa-plus me-2"></i>T·∫°o k·ª≥ thi m·ªõi
            </button>
        </div>

        <div class="row mb-4">
            <div class="col-md-6">
                <div class="position-relative">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" class="form-control search-box" placeholder="T√¨m ki·∫øm k·ª≥ thi..." id="examSearch">
                </div>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="upcoming">S·∫Øp di·ªÖn ra</option>
                    <option value="ongoing">ƒêang di·ªÖn ra</option>
                    <option value="completed">ƒê√£ k·∫øt th√∫c</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="sortBy">
                    <option value="">S·∫Øp x·∫øp theo</option>
                    <option value="newest">M·ªõi nh·∫•t</option>
                    <option value="oldest">C≈© nh·∫•t</option>
                    <option value="name">T√™n A-Z</option>
                </select>
            </div>
        </div>

        <div class="exam-table table-responsive">
            <table class="table table-hover" id="examTable">
                <thead>
                    <tr>
                        <th scope="col">T√™n k·ª≥ thi</th>
                        <th scope="col">Ng√†y thi</th>
                        <th scope="col">Ng√†y ƒëƒÉng k√Ω</th>
                        <th scope="col">Th√≠ sinh</th>
                        <th scope="col">M·∫≠t kh·∫©u</th>
                        <th scope="col">L·ªá ph√≠</th>
                        <th scope="col">Tr·∫°ng th√°i</th>
                        <th scope="col">H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="examList"></tbody>
            </table>
        </div>
    </div>

    <!-- Add Exam Modal -->
    <div class="modal fade" id="addExamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">T·∫°o k·ª≥ thi m·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addExamForm">
                        <div class="mb-3">
                            <label class="form-label mr-3">T√™n k·ª≥ thi</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="name" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ng√†y thi</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="startDate" >
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label type-date">Ng√†y ƒëƒÉng k√Ω</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="registDate" >
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S·ªë th√≠ sinh</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="amount" >  
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">L·ªá ph√≠ (VND)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="fee" min="0">
                            </div>
                        </div>
                        <div class="mb-3 input-group">
                            <label class="form-label">M·∫≠t kh·∫©u</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="password">
                            </div>
                        </div>
                        <div class="mb-3 input-group">
                            <label class="form-label">H·∫°n t·∫°o ƒë·ªÅ</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="createQuestionDue" >
                            </div>
                        </div>
                        <div class="mb-3">
                            <label>T√¨m ki·∫øm ng∆∞·ªùi ph·ª• tr√°ch</label>
                            <div class="input-group">
                                <input type="email" class="form-control w-100" name="email" id="searchEmail" placeholder="Nh·∫≠p email ƒë·ªÉ t√¨m ki·∫øm..." autocomplete="off">
                                <div id="searchResults" class="d-none w-100">
                                <div id="userSearchList" class="list-group w-100"></div>
                            </div>
                            </div>
                            
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="createExamBtn">T·∫°o m·ªõi</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Exam Modal -->
    <div class="modal fade" id="editExamModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ch·ªânh s·ª≠a k·ª≥ thi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editExamForm">
                        <input type="hidden" name="id">
                        <div class="mb-3">
                            <label class="form-label">T√™n k·ª≥ thi</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="name" >
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ng√†y thi</label>
                            <div class="input-group"> 
                                <input type="date" class="form-control" name="startDate" >
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ng√†y b·∫Øt ƒë·∫ßu ƒëƒÉng k√Ω</label>
                            <div class="input-group">
                                <input type="date" class="form-control" name="registDate" >
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">S·ªë th√≠ sinh</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="amount" >
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">L·ªá ph√≠ (VND)</label>
                            <div class="input-group">
                                <input type="number" class="form-control" name="fee" min="0">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M·∫≠t kh·∫©u</label>
                            <div class="input-group">
                                <input type="password" class="form-control" name="password">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">H·∫°n t·∫°o ƒë·ªÅ</label>
                            <div class="input-group">
                                <input type="date" class="form-control" name="createQuestionDue" >
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">T√¨m ki·∫øm ng∆∞·ªùi ph·ª• tr√°ch</label>
                            <div class="input-group">
                                <input type="email" class="form-control" id="editSearchEmail" placeholder="Nh·∫≠p email ƒë·ªÉ t√¨m ki·∫øm..." autocomplete="off">
                            </div>
                            <div id="editSearchResults" class="d-none">
                                <div id="editUserSearchList" class="list-group w-100"></div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-primary" id="updateExamBtn">C·∫≠p nh·∫≠t</button>
                </div>
            </div>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/additional-methods.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script type="module">
const now = new Date();   
// User data for search
let userData = [];

// Selected user ID for add/edit
let selectedUserId = null;
 
// end validate
function convertToISO(dateStr) {
    if (!dateStr) return null;
    const [timePart, datePart] = dateStr.trim().split(' ');
    const [day, month, year] = datePart.trim().split('/');
    const [hour, minute] = timePart.trim().split(':').map(Number);
    const dateObj = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day), hour, minute));
    return dateObj.toISOString();
}
 function fetchGetAccount(roleNumber) {
            return $.ajax({
                url: `https://localhost:7001/api/user/account-by-role/${roleNumber}`,
                type: 'GET',
                xhrFields: { withCredentials: true }
            });
        }

// Show toast notification
function showToast(message, type = 'success') {
    const $toast = $('#liveToast');
    $toast.removeClass('bg-success bg-danger bg-warning').addClass(`bg-${type}`);
    $toast.find('.toast-body').text(message);
    const toast = new bootstrap.Toast($toast[0]);
    toast.show();
}

// Format date to Vietnamese locale
function formatDate(dateString) {
    if (!dateString || dateString === '0001-01-01') return 'N/A';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return 'N/A';
        return date.toLocaleDateString('vi-VN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });
    } catch (e) {
        return 'N/A';
    }
}

// Format date for date input
function formatDateForInput(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '';
        return date.toISOString().split('T')[0];
    } catch (e) {
        return '';
    }
}

// Get exam status based on dates
function getExamStatus(startDate) {
    const now = new Date();
    const start = startDate ? new Date(startDate) : null;
    

    if (!start || isNaN(start.getTime()) ) {
        console.log('Invalid date(s):', { startDate});
        return 'completed';
    }

    if (now < start) return 'upcoming';
    if (now > start) return 'completed';
    return 'ongoing';
}

// Get status text and class
function getStatusInfo(status) {
    switch(status) {
        case 'upcoming':
            return { text: 'S·∫Øp di·ªÖn ra', class: 'status-upcoming', value: 'upcoming' };
        case 'ongoing':
            return { text: 'ƒêang di·ªÖn ra', class: 'status-ongoing', value: 'ongoing' };
        case 'completed':
            return { text: 'ƒê√£ k·∫øt th√∫c', class: 'status-completed', value: 'completed' };
        default:
            return { text: 'ƒê√£ k·∫øt th√∫c', class: 'status-completed', value: 'completed' };
    }
}

// Render exam row for table
function renderExamRow(exam) {
    const status = getExamStatus(exam.startDate);
    console.log('320', status)
    const statusInfo = getStatusInfo(status);
    const isDisabled = status === 'completed' ? 'disabled' : '';
    
    return `
        <tr data-status="${statusInfo.value}" data-exam-id="${exam.id}">
            <td>${exam.name || 'Kh√¥ng c√≥ t√™n'}</td>
            <td>${formatDateTime(exam.startDate)}</td>
            <td>${formatDateTime(exam.registDate)}</td>
            <td>${exam.amount || 0}</td>
            <td>${exam.password || 'N/A'}</td>
            <td>${exam.fee || 0}</td>
            <td><span class="badge ${statusInfo.class}">${statusInfo.text}</span></td>
            <td>
                <button class="btn btn-sm btn-warning action-btn edit-exam" title="S·ª≠a" ${isDisabled}>
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `;
}

// l·∫•y danh s√°ch k·ª≥ thi
function loadExams() {
    $.ajax({
        url: 'https://localhost:7001/api/exam',
        type: 'GET',
        xhrFields: { withCredentials: true },
        success: function(response) {
            console.log('API exams response:', response);
            const $examList = $('#examList');
            $examList.html(response.map(exam => renderExamRow(exam)).join(''));
            $examList.find('tr').on('click', function(e) {
                if ($(e.target).closest('.action-btn').length) return;
                const examId = $(this).data('exam-id');
                viewExamDetail(examId);
            });
        },
        error: function(error) {
            console.error('Error loading exams:', error);
            showToast('Kh√¥ng th·ªÉ t·∫£i danh s√°ch k·ª≥ thi!', 'danger');
        }
    });
}

        // Search users for exam creator
        // function searchUsers(searchTerm, searchInputId, resultsId, listId) {
        //     searchTerm = searchTerm ? searchTerm.toLowerCase().trim() : '';
        //     const $searchResults = $(`#${resultsId}`);
        //     const $userSearchList = $(`#${listId}`);

        //     $userSearchList.html('<div class="list-group-item text-center">ƒêang t·∫£i...</div>');
        //     $searchResults.removeClass('d-none');

        //     if (!userData || userData.length === 0) {
        //         $userSearchList.html(`
        //             <div class="list-group-item text-center text-muted">
        //                 Kh√¥ng c√≥ d·ªØ li·ªáu ng∆∞·ªùi d√πng
        //             </div>
        //         `);
        //         return;
        //     }

        //     const matchedUsers = searchTerm
        //         ? userData.filter(user => 
        //             user.email.toLowerCase().includes(searchTerm) ||
        //             user.fullName.toLowerCase().includes(searchTerm)
        //         )
        //         : userData;

        //     $userSearchList.empty();
        //     if (matchedUsers.length > 0) {
        //         const html = matchedUsers.map(user => {
        //             const highlightedEmail = searchTerm
        //                 ? user.email.replace(
        //                       new RegExp(searchTerm, 'gi'),
        //                       match => `<span class="bg-warning">${match}</span>`
        //                   )
        //                 : user.email;
        //             const highlightedName = searchTerm
        //                 ? user.fullName.replace(
        //                       new RegExp(searchTerm, 'gi'),
        //                       match => `<span class="bg-warning">${match}</span>`
        //                   )
        //                 : user.fullName;
        //             return `
        //                 <button type="button" class="list-group-item list-group-item-action user-search-item" data-user-id="${user.id}">
        //                     <div class="d-flex align-items-center">
        //                         <img src="${user.imageFaceBase64 || 'https://via.placeholder.com/32'}" class="rounded-circle me-2" width="32" height="32" alt="Avatar">
        //                         <div>
        //                             <div class="fw-bold">${highlightedName || 'Kh√¥ng c√≥ t√™n'}</div>
        //                             <small class="text-muted">${highlightedEmail}</small>
        //                         </div>
        //                     </div>
        //                 </button>
        //             `;
        //         }).join('');
        //         $userSearchList.append(html);
        //         $searchResults.removeClass('d-none');
        //     } else {
        //         $userSearchList.html(`
        //             <div class="list-group-item text-center text-muted">
        //                 Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ cho "${searchTerm}"
        //             </div>
        //         `);
        //         $searchResults.removeClass('d-none');
        //     }
        // }

function searchUsers(searchTerm, searchInputId, resultsId, listId) {
    searchTerm = searchTerm ? searchTerm.toLowerCase().trim() : '';
    const $searchInput = $(`#${searchInputId}`);
    const $searchResults = $(`#${resultsId}`);
    const $userSearchList = $(`#${listId}`);

    // X√≥a th√¥ng b√°o l·ªói c≈©
    $searchInput.closest('.input-group').find('.error').remove();
    $searchInput.removeClass('invalid valid');


    $userSearchList.html('<div class="list-group-item text-center">ƒêang t·∫£i...</div>');
    $searchResults.removeClass('d-none');

    if (!userData || userData.length === 0) {
        $userSearchList.html(`
            <div class="list-group-item text-center text-muted">
                Kh√¥ng c√≥ d·ªØ li·ªáu ng∆∞·ªùi d√πng
            </div>
        `);
        $searchResults.removeClass('d-none');
        return;
    }

    const matchedUsers = searchTerm
        ? userData.filter(user => 
            user.email.toLowerCase().includes(searchTerm) ||
            user.fullName.toLowerCase().includes(searchTerm)
          )
        : userData;

    $userSearchList.empty();
    if (matchedUsers.length > 0) {
        const html = matchedUsers.map(user => {
            const highlightedEmail = searchTerm
                ? user.email.replace(
                      new RegExp(searchTerm, 'gi'),
                      match => `<span class="bg-warning">${match}</span>`
                  )
                : user.email;
            const highlightedName = searchTerm
                ? user.fullName.replace(
                      new RegExp(searchTerm, 'gi'),
                      match => `<span class="bg-warning">${match}</span>`
                  )
                : user.fullName;
            return `
                <button type="button" class="list-group-item list-group-item-action user-search-item" data-user-id="${user.id}">
                    <div class="d-flex align-items-center">
                        <img src="${user.imageFaceBase64 || 'https://via.placeholder.com/32'}" class="rounded-circle me-2" width="32" height="32" alt="Avatar">
                        <div>
                            <div class="fw-bold">${highlightedName || 'Kh√¥ng c√≥ t√™n'}</div>
                            <small class="text-muted">${highlightedEmail}</small>
                        </div>
                    </div>
                </button>
            `;
        }).join('');
        $userSearchList.append(html);
        $searchResults.removeClass('d-none');
        $searchInput.addClass('valid');
    
    } else {
        // Hi·ªÉn th·ªã to√†n b·ªô danh s√°ch ng∆∞·ªùi d√πng khi kh√¥ng c√≥ searchTerm
        const html = userData.map(user => {
            return `
                <button type="button" class="list-group-item list-group-item-action user-search-item" data-user-id="${user.id}">
                    <div class="d-flex align-items-center">
                        <img src="${user.imageFaceBase64 || 'https://via.placeholder.com/32'}" class="rounded-circle me-2" width="32" height="32" alt="Avatar">
                        <div>
                            <div class="fw-bold">${user.fullName || 'Kh√¥ng c√≥ t√™n'}</div>
                            <small class="text-muted">${user.email}</small>
                        </div>
                    </div>
                </button>
            `;
        }).join('');
        $userSearchList.append(html);
        $searchResults.removeClass('d-none');
        $searchInput.addClass('valid');
    }
}  

$('#searchEmail').on('focus', function() {
        searchUsers('', 'searchEmail', 'searchResults', 'userSearchList');
    });

    // S·ª± ki·ªán focus cho √¥ t√¨m ki·∫øm email trong modal ch·ªânh s·ª≠a k·ª≥ thi
$('#editSearchEmail').on('focus', function() {
    searchUsers('', 'editSearchEmail', 'editSearchResults', 'editUserSearchList');
});
        // Create new exam
function createExam() {
    const $form = $('#addExamForm');
    // if (!$form[0].checkValidity()) {
    //     $form[0].reportValidity();
    //     return;
    // }
    if(!$form.valid()) {
        return;
    }
    const formData = new FormData($form[0]);
    const examData = {
        Name: formData.get('name'),
        StartDate: convertToISO(formData.get('startDate')),
        RegistDate: convertToISO(formData.get('registDate')),
        CreateQuestionDue: convertToISO(formData.get('createQuestionDue')),
        Password: formData.get('password'),
        Amount: parseInt(formData.get('amount')),
        Fee: formData.get('fee') ? parseFloat(formData.get('fee')) : null,
        Email: formData.get('email')
    };
    
    $.ajax({
        url: 'https://localhost:7001/api/exam',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(examData),
        xhrFields: { withCredentials: true },
        success: function(response) {
            const modal = bootstrap.Modal.getInstance($('#addExamModal')[0]);
            modal.hide();
            $form[0].reset();
            $('#searchEmail').val('');
            selectedUserId = null;
            $('#searchResults').addClass('d-none');
            $('#userSearchList').empty();
            loadExams();
            Swal.fire({
                icon: 'success',
                title: 'Th√†nh c√¥ng',
                text: 'Th√™m k·ª≥ thi th√†nh c√¥ng'
            })
        },
        error: function(error) {
            console.log('Error creating exam:', error.responseText);
            Swal.fire({
                icon: 'error',
                title: 'L·ªói',
                text: error.responseJSON.Message
            })
        }
    });
}

function formatDateTime(dateTimeStr) {
    const date = new Date(dateTimeStr);

    const pad = num => num.toString().padStart(2, '0');

    const hours = pad(date.getHours());
    const minutes = pad(date.getMinutes());
    const day = pad(date.getDate());
    const month = pad(date.getMonth() + 1); // Th√°ng b·∫Øt ƒë·∫ßu t·ª´ 0
    const year = date.getFullYear();

    return `${hours}:${minutes} ${day}/${month}/${year}`;
}

// Show edit exam modal
function showEditExamModal(examId) {
    $.ajax({
        url: `https://localhost:7001/api/exam/exam/${examId}`,
        type: 'GET',
        xhrFields: { withCredentials: true },
        success: function(exam) {
            const $form = $('#editExamForm');
            $form.find('input').removeClass('invalid');
            $form.find('.input-group').each(function () {
                const $next = $(this).next();
                $next.remove();
            });
            $form.find('[name="id"]').val(exam.id);
            $form.find('[name="name"]').val(exam.name);
            $form.find('[name="startDate"]').val(formatDateTime(exam.startDate));
            $form.find('[name="registDate"]').val(formatDateTime(exam.registDate));
            $form.find('[name="amount"]').val(exam.amount);
            $form.find('[name="fee"]').val(exam.fee || '');
            $form.find('[name="password"]').val(exam.password || '');
            $form.find('[name="createQuestionDue"]').val(formatDateTime(exam.createQuestionDue));
            
            const user = userData.find(u => u.id === exam.createdQuestionUserId);
            selectedUserId = exam.createdQuestionUserId;
            $('#editSearchEmail').val(user ? user.email : '');

            const modal = new bootstrap.Modal($('#editExamModal')[0]);
            modal.show();
        },
        error: function(error) {
            console.error('Error fetching exam:', error);
            showToast('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin k·ª≥ thi!', 'danger');
        }
    });
}

// Update exam
function updateExam() {
    const $form = $('#editExamForm');
    if (!$form[0].checkValidity()) {
        $form[0].reportValidity();
        return;
    }

    const formData = new FormData($form[0]);
    const examData = {
        Id: formData.get('id'),
        Name: formData.get('name'),
        StartDate: formData.get('startDate'),
        RegistDate: formData.get('registDate'),
        CreateQuestionDue: formData.get('createQuestionDue'),
        Password: formData.get('password'),
        Amount: parseInt(formData.get('amount')),
        Fee: formData.get('fee') ? parseFloat(formData.get('fee')) : null,
        CreatedQuestionUserId: selectedUserId
    };

    if (!selectedUserId) {
        showToast('Vui l√≤ng ch·ªçn ng∆∞·ªùi ph·ª• tr√°ch!', 'warning');
        return;
    }

    $.ajax({
        url: `https://localhost:7001/api/exam`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(examData),
        xhrFields: { withCredentials: true },
        success: function(response) {
            const modal = bootstrap.Modal.getInstance($('#editExamModal')[0]);
            modal.hide();
            $form[0].reset();
            $('#editSearchEmail').val('');
            selectedUserId = null;
            $('#editSearchResults').addClass('d-none');
            $('#editUserSearchList').empty();
            loadExams();
            showToast('C·∫≠p nh·∫≠t k·ª≥ thi th√†nh c√¥ng!', 'success');
        },
        error: function(error) {
            console.error('Error updating exam:', error);
            showToast('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t k·ª≥ thi!', 'danger');
        }
    });
}

// Delete exam
function deleteExam(examId) {
    $('#confirmDeleteBtn').off('click').on('click', function() {
        $.ajax({
            url: `https://localhost:7001/api/exam/${examId}`,
            type: 'DELETE',
            xhrFields: { withCredentials: true },
            success: function() {
                const modal = bootstrap.Modal.getInstance($('#confirmDeleteModal')[0]);
                modal.hide();
                loadExams();
                showToast('X√≥a k·ª≥ thi th√†nh c√¥ng!', 'success');
            },
            error: function(error) {
                console.error('Error deleting exam:', error);
                showToast('C√≥ l·ªói x·∫£y ra khi x√≥a k·ª≥ thi!', 'danger');
            }
        });
    });
    const modal = new bootstrap.Modal($('#confirmDeleteModal')[0]);
    modal.show();
}

// View exam detail
function viewExamDetail(examId) {
    localStorage.setItem('examId', examId);
    window.location.href = `exam-detail.html`;
}

function convertStringToDate(dateStr) {
    
    const [day, month, year] = dateStr.split('/').map(Number);
    const date = new Date(year, month - 1, day);
    return date
}

$(document).ready(function() {

    // validate add form
    $('#addExamForm').validate({
    rules: {
        name: { required: true },
        startDate: { required: true },
        registDate: { required: true },
        amount: {
            required: true,
            digitsOnly: true,
            min: 1,
            number: true
        },
        fee: {
            required: true,
            digitsOnly: true,
            min: 1,
            number: true
        },
        password: { required: true },
        createQuestionDue: { required: true },
        email: {
            required: true,
            email: true,
            userExists: true,
        }
    },
    messages: {
        name: "Vui l√≤ng nh·∫≠p t√™n k·ª≥ thi",
        startDate: "Vui l√≤ng ch·ªçn ng√†y thi",
        registDate: "Vui l√≤ng ch·ªçn ng√†y ƒëƒÉng k√Ω",
        amount: {
            required: "Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng",
            digitsOnly: "Vui l√≤ng nh·∫≠p s·ªë t·ª± nhi√™n",
            min: "S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0",
            number: "Vui l√≤ng nh·∫≠p s·ªë"
        },
        fee: {
            required: "Vui l√≤ng nh·∫≠p l·ªá ph√≠",
            digitsOnly: "Vui l√≤ng nh·∫≠p s·ªë t·ª± nhi√™n",
            min: "L·ªá ph√≠ ph·∫£i l·ªõn h∆°n 0",
            number: "Vui l√≤ng nh·∫≠p s·ªë"
        },
        password: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u",
        createQuestionDue: "Vui l√≤ng nh·∫≠p h·∫°n ch√≥t t·∫°o c√¢u h·ªèi",
        email: {
            required: "Vui l√≤ng nh·∫≠p email",
            email: "Email kh√¥ng h·ª£p l·ªá",
        }
    },
    errorElement: 'div',
    errorPlacement: function(error, el) {
        error.addClass('error');
        error.insertAfter(el.closest('.input-group'));
    },
    onkeyup: function(element) {
        $(element).valid(); // ki·ªÉm tra l·∫°i khi ng∆∞·ªùi d√πng g√µ
    },
    onfocusout: function(element) {
        $(element).valid(); // ki·ªÉm tra l·∫°i khi r·ªùi kh·ªèi √¥ nh·∫≠p
    },
    highlight: function(el) {
        $(el).addClass('invalid').removeClass('valid');
    },
    unhighlight: function(el) {
        $(el).removeClass('invalid').addClass('valid');
    }
    });

    $('#editExamForm').validate({
    rules: {
        name: { required: true },
        startDate: { required: true },
        registDate: { required: true },
        amount: {
            required: true,
            digitsOnly: true,
            min: 1,
            number: true
        },
        fee: {
            required: true,
            digitsOnly: true,
            min: 1,
            number: true
        },
        password: { required: true },
        createQuestionDue: { required: true },
        email: {
            required: true,
            email: true,
            userExists: true,
        }
    },
    messages: {
        name: "Vui l√≤ng nh·∫≠p t√™n k·ª≥ thi",
        startDate: "Vui l√≤ng ch·ªçn ng√†y thi",
        registDate: "Vui l√≤ng ch·ªçn ng√†y ƒëƒÉng k√Ω",
        amount: {
            required: "Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng",
            digitsOnly: "Vui l√≤ng nh·∫≠p s·ªë t·ª± nhi√™n",
            min: "S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0",
            number: "Vui l√≤ng nh·∫≠p s·ªë"
        },
        fee: {
            required: "Vui l√≤ng nh·∫≠p l·ªá ph√≠",
            digitsOnly: "Vui l√≤ng nh·∫≠p s·ªë t·ª± nhi√™n",
            min: "L·ªá ph√≠ ph·∫£i l·ªõn h∆°n 0",
            number: "Vui l√≤ng nh·∫≠p s·ªë"
        },
        password: "Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u",
        createQuestionDue: "Vui l√≤ng nh·∫≠p h·∫°n ch√≥t t·∫°o c√¢u h·ªèi",
        email: {
            required: "Vui l√≤ng nh·∫≠p email",
            email: "Email kh√¥ng h·ª£p l·ªá",
        }
    },
    errorElement: 'div',
    errorPlacement: function(error, el) {
        error.addClass('error');
        error.insertAfter(el.closest('.input-group'));
    },
    onkeyup: function(element) {
        $(element).valid(); // ki·ªÉm tra l·∫°i khi ng∆∞·ªùi d√πng g√µ
    },
    onfocusout: function(element) {
        $(element).valid(); // ki·ªÉm tra l·∫°i khi r·ªùi kh·ªèi √¥ nh·∫≠p
    },
    highlight: function(el) {
        $(el).addClass('invalid').removeClass('valid');
    },
    unhighlight: function(el) {
        $(el).removeClass('invalid').addClass('valid');
    }
    });

    // Th√™m quy t·∫Øc validate t√πy ch·ªânh ƒë·ªÉ ki·ªÉm tra email t·ªìn t·∫°i
    $.validator.addMethod("userExists", function(value, element) {
        return userData.some(user => user.email.toLowerCase() === value.toLowerCase());
    }, "Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi email n√†y");
    $.validator.addMethod("digitsOnly", function(value, element) {
    return this.optional(element) || /^[1-9]\d*$/.test(value);
    }, "Ch·ªâ ƒë∆∞·ª£c nh·∫≠p s·ªë nguy√™n d∆∞∆°ng");

    // l·∫•y danh s√°ch ng∆∞·ªùi t·∫°o ƒë·ªÅ
    fetchGetAccount(3)
        .done(response => {
            userData = response.map(user => ({
                id: user.id || '',
                email: user.email || '',
                fullName: user.fullName || '',
                imageFaceBase64: user.imageFaceBase64 || null
            }));
            loadExams();
        })
        .fail(error => {
            console.error('Error fetching users:', error);
            showToast('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ng∆∞·ªùi d√πng!', 'danger');
            
            loadExams();
        });

    $('#examSearch').on('input', function() {
        const searchTerm = $(this).val().toLowerCase();
        $('#examList tr').each(function() {
            const examName = $(this).find('td').eq(0).text().toLowerCase();
            $(this).toggle(examName.includes(searchTerm));
        });
    });

    $('#statusFilter').on('change', function() {
        const status = $(this).val();
        $('#examList tr').each(function() {
            const rowStatus = $(this).data('status');
            $(this).toggle(!status || rowStatus === status);
        });
    });

    $('#sortBy').on('change', function() {
        const sortBy = $(this).val();
        const $examList = $('#examList');
        const $examRows = $examList.children('tr').get();

        $examRows.sort(function(a, b) {
            const nameA = $(a).find('td').eq(0).text();
            const nameB = $(b).find('td').eq(0).text();
            const startDateA = convertStringToDate($(a).find('td').eq(1).text());
            const startDateB = convertStringToDate($(b).find('td').eq(1).text());

            switch(sortBy) {
                case 'newest':
                    return startDateB - startDateA;
                case 'oldest':
                    return startDateA - startDateB;
                case 'name':
                    return nameA.localeCompare(nameB);
                case 'amount':
                    return parseInt($(a).find('td').eq(3).text()) - parseInt($(b).find('td').eq(3).text());
                default:
                    return 0;
            }
        });

        $examList.empty().append($examRows);
    });

    $('#searchEmail').on('input', function() {
        searchUsers($(this).val(), 'searchEmail', 'searchResults', 'userSearchList');
    })

    $('#editSearchEmail').on('input', function() {
        searchUsers($(this).val(), 'editSearchEmail', 'editSearchResults', 'editUserSearchList');
    })

    $(document).on('click', '.user-search-item', function() {
    const userId = $(this).data('user-id');
    const email = $(this).find('.text-muted').text();
    const $searchInput = $(this).closest('.modal').find('input[type="email"]');
    const $results = $(this).closest('.modal').find('.d-none');
    const $list = $(this).closest('.list-group');

    selectedUserId = userId;
    $searchInput.val(email);
    $results.addClass('d-none');
    $list.empty();

    $('.user-search-item').removeClass('active');
    $(this).addClass('active');

    // K√≠ch ho·∫°t ki·ªÉm tra validation ngay sau khi ch·ªçn email
    $searchInput.valid();
    });

    $(document).on('click', function(e) {
    if (!$(e.target).closest('#searchEmail, #editSearchEmail, #searchResults, #editSearchResults').length) {
        $('#searchResults, #editSearchResults').addClass('d-none');
        $('#userSearchList, #editUserSearchList').empty();
    }
    });

    $('#createExamBtn').on('click', createExam);
    $('#updateExamBtn').on('click', updateExam);

    $(document).on('click', '.edit-exam:not(:disabled)', function(e) {
    e.stopPropagation();
    const examId = $(this).closest('tr').data('exam-id');
    showEditExamModal(examId);
    });

    $(document).on('click', '.delete-exam:not(:disabled)', function(e) {
    e.stopPropagation();
    const examId = $(this).closest('tr').data('exam-id');
    deleteExam(examId);
    });

    const now = new Date();
    const oneMonthLater = new Date(now.getFullYear(), now.getMonth() + 1, now.getDate());

    var startDatePicker = flatpickr('input[name="startDate"]', {
        enableTime: true,
        dateFormat: "H:i d/m/Y",
        time_24hr: true,
            onOpen: function(selectedDates, dateStr, instance) {
        const now = new Date();

        // Ng√†y hi·ªán t·∫°i + 1 th√°ng
        const oneMonthLater = new Date(now);
        oneMonthLater.setMonth(now.getMonth() + 1);

        // Helper: parse ng√†y t·ª´ input theo format "H:i d/m/Y"
        function parseDateFromInput(inputName) {
            const val = document.querySelector(`input[name="${inputName}"]`)?.value;
            if (!val) return null;
            const [time, date] = val.split(" ");
            const [hour, minute] = time.split(":").map(Number);
            const [day, month, year] = date.split("/").map(Number);
            return new Date(year, month - 1, day, hour, minute);
        }

        // Ng√†y ƒëƒÉng k√Ω + 14 ng√†y
        const registDate = parseDateFromInput("registDate");
        const registPlus14 = registDate ? new Date(registDate.getTime() + 14 * 86400000) : null;

        // Ng√†y h·∫°n t·∫°o c√¢u + 7 ng√†y
        const questionDate = parseDateFromInput("createQuestionDue");
        const questionPlus7 = questionDate ? new Date(questionDate.getTime() + 7 * 86400000) : null;

        // T√¨m ng√†y l·ªõn nh·∫•t
        const allDates = [oneMonthLater, registPlus14, questionPlus7].filter(d => d instanceof Date && !isNaN(d));
        const maxDate = new Date(Math.max(...allDates.map(d => d.getTime())));

        // G√°n minDate
        instance.set('minDate', maxDate);
    },
        onChange: function(selectedDates, dateStr, instance) {
            $(instance.element).valid();
        }
    });


    const registDatePicker = flatpickr('input[name="registDate"]', {
        enableTime: true,
        dateFormat: "H:i d/m/Y",
        time_24hr: true,
        // minDate: new Date(now.getTime() + 14 * 86400000),
        onOpen: function(selectedDates, dateStr, instance) {
            const todayPlus14 = new Date(now.getTime() + 7 * 86400000);
            instance.set('minDate', todayPlus14);

        // üëá L·∫•y gi√° tr·ªã input[name="startDate"] v√† chuy·ªÉn th√†nh Date
            const startDateInputVal = document.querySelector('input[name="startDate"]').value;

            if (startDateInputVal) {
                // Parse ng∆∞·ª£c l·∫°i t·ª´ ƒë·ªãnh d·∫°ng "H:i d/m/Y" v·ªÅ Date
                const parts = startDateInputVal.split(' ');
                const timeParts = parts[0].split(':');
                const dateParts = parts[1].split('/');

                const startDate = new Date(
                    parseInt(dateParts[2]),     // year
                    parseInt(dateParts[1]) - 1, // month (0-indexed)
                    parseInt(dateParts[0]),     // day
                    parseInt(timeParts[0]),     // hours
                    parseInt(timeParts[1])      // minutes
                );

                if (!isNaN(startDate.getTime())) {
                    const maxDate = new Date(startDate.getTime() - 14 * 86400000);
                    instance.set('maxDate', maxDate);
                } else {
                    instance.set('maxDate', null);
                }
            } else {
                instance.set('maxDate', null);
            }
        },
        onChange: function(selectedDates, dateStr, instance) {
            $(instance.element).valid();
        }
    });

    const createDuePicker = flatpickr('input[name="createQuestionDue"]', {
            enableTime: true,
            dateFormat: "H:i d/m/Y",
            time_24hr: true,
            // minDate: new Date(now.getTime() + 14 * 86400000),
            onOpen: function(selectedDates, dateStr, instance) {
                const todayPlus14 = new Date(now.getTime() + 21 * 86400000);
                instance.set('minDate', todayPlus14);

            // üëá L·∫•y gi√° tr·ªã input[name="startDate"] v√† chuy·ªÉn th√†nh Date
                const startDateInputVal = document.querySelector('input[name="startDate"]').value;

                if (startDateInputVal) {
                    // Parse ng∆∞·ª£c l·∫°i t·ª´ ƒë·ªãnh d·∫°ng "H:i d/m/Y" v·ªÅ Date
                    const parts = startDateInputVal.split(' ');
                    const timeParts = parts[0].split(':');
                    const dateParts = parts[1].split('/');

                    const startDate = new Date(
                        parseInt(dateParts[2]),     // year
                        parseInt(dateParts[1]) - 1, // month (0-indexed)
                        parseInt(dateParts[0]),     // day
                        parseInt(timeParts[0]),     // hours
                        parseInt(timeParts[1])      // minutes
                    );

                    if (!isNaN(startDate.getTime())) {
                        const maxDate = new Date(startDate.getTime() - 5 * 86400000);
                        instance.set('maxDate', maxDate);
                    } else {
                        instance.set('maxDate', null);
                    }
                } else {
                    instance.set('maxDate', null);
                }
            },
            onChange: function(selectedDates, dateStr, instance) {
                $(instance.element).valid();
            }
        });
// end document
});
    </script>
</body>
</html>