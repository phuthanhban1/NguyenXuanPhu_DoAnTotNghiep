<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý ngân hàng đề thi</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.min.css">
    <style>
        body { background: #f8f9fa; }
        .sidebar {
            min-width: 220px;
            max-width: 240px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 24px 0;
            height: 100vh;
        }
        .sidebar .nav-link {
            color: #333;
            font-weight: 500;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover {
            background-color: #e9ecef;
        }
        .sidebar .nav-link.active {
            background: #e9ecef;
            color: #0d6efd;
        }
        .sidebar .nav .nav {
            margin-left: 1rem;
        }
        .content-area {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            padding: 32px;
            min-height: 400px;
        }
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background-color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 1.8rem;
        }
        .info-section {
            margin-bottom: 25px;
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
        }
        .info-section:hover {
            transform: translateY(-5px);
        }
        .info-section h2 {
            color: #34495e;
            font-size: 1.2em;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #3498db;
            font-weight: 600;
        }
        .info-content {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        .info-item {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            flex: 1;
            min-width: 200px;
            transition: all 0.3s ease;
            border: 1px solid #e9ecef;
        }
        .info-item:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #3498db;
        }
        .info-item h3 {
            color: #7f8c8d;
            font-size: 0.9em;
            margin-bottom: 6px;
            font-weight: 500;
        }
        .info-item p {
            color: #2c3e50;
            font-size: 1.1em;
            font-weight: 500;
            margin: 0;
        }
        .confirm-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 25px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .confirm-btn:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        #no-task-message {
            text-align: center;
            padding: 40px 20px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        #no-task-message i {
            font-size: 3em;
            color: #bdc3c7;
            margin-bottom: 15px;
        }
        #no-task-message h3 {
            color: #7f8c8d;
            font-size: 1.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }
        #no-task-message p {
            color: #95a5a6;
            font-size: 1em;
            max-width: 400px;
            margin: 0 auto;
        }
        .skill-info {
            padding: 10px;
        }
        .skill-info .d-flex {
            padding: 10px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .skill-info .d-flex:hover {
            background-color: #f8f9fa;
        }
        .skill-info i {
            font-size: 1.2em;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(52, 152, 219, 0.1);
        }
        .skill-info h3 {
            font-size: 0.85em;
            color: #7f8c8d;
            margin-bottom: 4px;
        }
        .skill-info p {
            font-size: 1em;
            color: #2c3e50;
            font-weight: 500;
            margin: 0;
        }
        .bank-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            background-color: #fff;
            border: 1px solid #dee2e6;
        }
        .bank-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 15px 20px;
        }
        .bank-card .card-body {
            padding: 20px;
        }
        .action-button {
            width: 100%;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 8px;
            text-align: left;
            transition: all 0.3s ease;
        }
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .action-button i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .status-badge {
            font-size: 0.9em;
            padding: 5px 10px;
            border-radius: 15px;
        }
        .deadline-info {
            color: #6c757d;
            font-size: 0.9em;
        }
        .deadline-warning {
            color: #dc3545;
        }
        .confirm-button {
            width: 100%;
            margin-top: 10px;
        }
        .dropdown {
            position: relative;
        }
        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            margin-top: 5px;
            padding: 5px;
            z-index: 1000;
        }
        .dropdown-item {
            color: #333;
            padding: 8px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .dropdown-item:hover {
            background-color: #e9ecef;
        }
        .dropdown-item.active {
            background-color: #0d6efd;
            color: white;
        }
        .dropdown-item i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .question-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
            background-color: #fff;
        }
        .question-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 15px 20px;
        }
        .question-card .card-body {
            padding: 20px;
        }
        .answer-option {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        .answer-option:hover {
            border-color: #0d6efd;
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.1);
            background-color: #fff;
        }
        #questionList {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        .question-card {
            position: relative;
            overflow: hidden;
        }
        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: #0d6efd;
        }
        .question-card .card-header h5 {
            color: #0d6efd;
            font-weight: 600;
        }
        .question-card .btn-danger {
            padding: 5px 10px;
            border-radius: 5px;
        }
        .question-card .form-check {
            margin-bottom: 15px;
        }
        .question-card .form-label {
            font-weight: 500;
            color: #495057;
        }
        .question-card textarea,
        .question-card input[type="text"] {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px;
        }
        .question-card textarea:focus,
        .question-card input[type="text"]:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
        /* Modal styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1050;
        }
        .modal-popup {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1051;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-popup.show {
            display: block;
            animation: modalFadeIn 0.3s;
        }
        .modal-overlay.show {
            display: block;
        }
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to {
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
        .question-type-card {
            transition: all 0.3s ease;
        }
        .question-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar -->
            <nav class="col-md-3 col-lg-2 sidebar">
                <ul class="nav flex-column">
                    <li class="nav-item mb-2">
                        <a class="nav-link active" id="menu-dashboard" href="trang-chu.html">
                            <i class="fas fa-home"></i>Trang chủ
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" id="menu-question-type" href="dang-cau-hoi.html" >
                            <i class="fas fa-list-ul"></i>Quản lý dạng câu hỏi
                        </a>
                    </li>
                    <li class="nav-item mb-2">
                        <a class="nav-link" id="menu-question" href="#" onclick="toggleSubMenu(event)">
                            <i class="fas fa-tasks"></i>Quản lý câu hỏi
                            <i class="fas fa-chevron-down float-end"></i>
                        </a>
                        <ul class="nav flex-column ms-3 mt-2 d-none" id="submenu-question">
                            <li class="nav-item mb-1">
                                <a class="nav-link" id="menu-add-question" href="them-cau-hoi.html">
                                    <i class="fas fa-plus-circle"></i>Thêm câu hỏi
                                </a>
                            </li>
                            <li class="nav-item mb-1">
                                <a class="nav-link" id="menu-approved-questions" href="da-duyet.html" >
                                    <i class="fas fa-check-circle"></i>Câu hỏi đã duyệt
                                </a>
                            </li>
                            <li class="nav-item mb-1">
                                <a class="nav-link" id="menu-pending-questions" href="cho-duyet.html" >
                                    <i class="fas fa-clock"></i>Câu hỏi chờ duyệt
                                </a>
                            </li>
                            <li class="nav-item mb-1">
                                <a class="nav-link" id="menu-rejected-questions" href="bi-tu-choi.html">
                                    <i class="fas fa-times-circle"></i>Câu hỏi bị từ chối
                                </a>
                            </li>
                            <li class="nav-item mb-1">
                                <a class="nav-link" id="menu-used-questions" href="da-dung.html">
                                    <i class="fas fa-times-circle"></i>Câu hỏi đã dùng
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                </ul>
            </nav>

            <!-- Main content -->
            <main class="col-md-9 col-lg-10">
                <!-- Existing content sections -->
                
                <!-- Add question section -->
                <div id="add-question" class="content-section" style="display: none;">
                    <div class="container-fluid py-5">
                        <!-- Header with Breadcrumb -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb mb-0">
                                        <li class="breadcrumb-item"><a href="#" class="text-decoration-none">Ngân hàng đề</a></li>
                                        <li class="breadcrumb-item" id="bank-name"></li>
                                        <li class="breadcrumb-item" id="skill-name"></li>
                                        <li class="breadcrumb-item active">Thêm câu hỏi</li>
                                    </ol>
                                </nav>
                                <h2 class="mt-2">
                                    <i class="fas fa-plus-circle text-primary me-2"></i>
                                    Thêm câu hỏi mới
                                </h2>
                            </div>
                        </div>

                        <!-- Question form -->
                        <div class="card">
                            <div class="card-body">
                                <form id="questionForm">
                                    <!-- Question type selection -->
                                    <div class="mb-4">
                                        <label class="form-label">Loại câu hỏi</label>
                                        <select class="form-select" id="questionCategory">
                                            <option value="">Chọn loại câu hỏi...</option>
                                        </select>
                                    </div>

                                    <!-- Question list -->
                                    <div id="questionList"></div>

                                    <!-- Add question button -->
                                    <div class="text-center mt-4">
                                        <button type="button" class="btn btn-primary" id="btn-add-question">
                                            <i class="fas fa-plus me-2"></i>Thêm câu hỏi
                                        </button>
                                    </div>

                                    <!-- Submit button -->
                                    <div class="text-center mt-4">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-save me-2"></i>Lưu câu hỏi
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div> 
    


    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.7.32/dist/sweetalert2.all.min.js"></script>
    
    <script>
       
    
    let questionCounter = 0; // Thêm biến đếm số câu hỏi
    var skillName = '';
    function createSingleFormHtml(hasImage = false, skillName = 'nghe') {
        return `
        <div id="singleQuestionForm">
            <div class="card question-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><span class="badge bg-primary">Câu ${questionCounter + 1}</span></h5>
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteQuestion(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- Thêm hình ảnh -->
                    <div id="singleQuestionImage" class="mt-2" ${!hasImage ? 'style="display:none;"' : ''}>
                        <label class="form-label">Hình ảnh câu hỏi</label>
                        <input type="file" accept="image/*" class="form-control image-input" onchange="previewSingleImage(event, ${questionCounter})">
                        <img id="singleImagePreview_${questionCounter}" src="" alt="Xem trước ảnh" style="max-width:200px; margin-top:10px; display:none;">
                    </div>
                    <!-- Nội dung câu hỏi text -->
                    <div class="mb-3">
                        <label class="form-label">Nội dung câu hỏi</label>
                        <div id="singleQuestionText">
                            <textarea class="form-control" rows="4" placeholder="Nhập nội dung câu hỏi..."></textarea>
                        </div>
                    </div>
                    <!-- Điểm số -->
                    <div class="mb-3">
                        <label class="form-label">Điểm số</label>
                        <input type="number" class="form-control score-input" min="0" max="10" step="0.5" value="1">
                    </div>
                    <!-- Âm thanh -->
                    <div id="singleQuestionAudio_${questionCounter}" class="mt-3 audio-input" ${skillName !== 'nghe' ? 'style="display:none;"' : ''}>
                        <label class="form-label">File âm thanh</label>
                        <input type="file" accept="audio/*" class="form-control" onchange="previewAudio(event, ${questionCounter})">
                        <audio id="audioPreview_${questionCounter}" controls style="display:none; margin-top:10px;"></audio>
                    </div>
                    <!-- Đáp án -->
                    <div class="mb-3">
                        <label class="form-label">Đáp án</label>
                        <div id="answerOptions">
                            <div class="answer-option">
                                <div class="d-flex align-items-center mb-2">
                                    <input type="radio" class="form-check-input me-2" name="correctAnswer_${questionCounter}" checked>
                                    <input type="text" class="form-control" placeholder="Đáp án A" required>
                                </div>
                            </div>
                            <div class="answer-option">
                                <div class="d-flex align-items-center mb-2">
                                    <input type="radio" class="form-check-input me-2" name="correctAnswer_${questionCounter}">
                                    <input type="text" class="form-control" placeholder="Đáp án B" required>
                                </div>
                            </div>
                            <div class="answer-option">
                                <div class="d-flex align-items-center mb-2">
                                    <input type="radio" class="form-check-input me-2" name="correctAnswer_${questionCounter}">
                                    <input type="text" class="form-control" placeholder="Đáp án C" required>
                                </div>
                            </div>
                            <div class="answer-option">
                                <div class="d-flex align-items-center mb-2">
                                    <input type="radio" class="form-check-input me-2" name="correctAnswer_${questionCounter}">
                                    <input type="text" class="form-control" placeholder="Đáp án D" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    function createDoubleFormHtml(hasImage = false, skillName = 'nghe') {
        return `
        <div id="doubleQuestionForm">
            <div class="card question-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Câu hỏi đọc chọn ý <span class="badge bg-primary">Câu ${questionCounter + 1}</span></h5>
                    <button type="button" class="btn btn-danger btn-sm" onclick="deleteQuestion(this)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- Đoạn văn -->
                    <div class="mb-4">
                        <label class="form-label">Đoạn văn</label>
                        <textarea class="form-control" rows="4" placeholder="Nhập đoạn văn..."></textarea>
                    </div>
                    <!-- Hình ảnh -->
                    <div id="doubleQuestionImage" class="mt-2" ${!hasImage ? 'style="display:none;"' : ''}>
                        <label class="form-label">Hình ảnh câu hỏi</label>
                        <input type="file" accept="image/*" class="form-control" onchange="previewDoubleImage(event)">
                        <img id="doubleImagePreview" src="" alt="Xem trước ảnh" style="max-width:200px; margin-top:10px; display:none;">
                    </div>
                    <!-- Âm thanh -->
                    <div id="doubleQuestionAudio" class="mt-3 audio-input" ${skillName !== 'nghe' ? 'style="display:none;"' : ''}>
                        <label class="form-label">File âm thanh</label>
                        <input type="file" accept="audio/*" class="form-control" onchange="previewAudio(event)">
                        <audio id="audioPreview" controls style="display:none; margin-top:10px;"></audio>
                    </div>
                    <!-- Câu hỏi nhỏ -->
                    <div id="subQuestions">
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Câu hỏi nhỏ 1</strong>
                                </div>
                                <div id="subQuestionText0">
                                    <input type="text" class="form-control" placeholder="Nhập nội dung câu hỏi nhỏ...">
                                </div>
                                <!-- Điểm số cho câu hỏi nhỏ 1 -->
                                <div class="mb-3 mt-2">
                                    <label class="form-label">Điểm số</label>
                                    <input type="number" class="form-control score-input" min="0" max="10" step="0.5" value="1">
                                </div>
                                <div>
                                    <label class="form-label">Đáp án</label>
                                    <div class="sub-answer-options">
                                        <div class="answer-option">
                                            <div class="d-flex align-items-center mb-2">
                                                <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_0" checked>
                                                <input type="text" class="form-control" placeholder="Đáp án A">
                                            </div>
                                        </div>
                                        <div class="answer-option">
                                            <div class="d-flex align-items-center mb-2">
                                                <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_0">
                                                <input type="text" class="form-control" placeholder="Đáp án B">
                                            </div>
                                        </div>
                                        <div class="answer-option">
                                            <div class="d-flex align-items-center mb-2">
                                                <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_0">
                                                <input type="text" class="form-control" placeholder="Đáp án C">
                                            </div>
                                        </div>
                                        <div class="answer-option">
                                            <div class="d-flex align-items-center mb-2">
                                                <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_0">
                                                <input type="text" class="form-control" placeholder="Đáp án D">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="subQuestions">
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <strong>Câu hỏi nhỏ 2</strong>
                                </div>
                                <div id="subQuestionText1">
                                    <input type="text" class="form-control" placeholder="Nhập nội dung câu hỏi nhỏ...">
                                </div>
                                <!-- Điểm số cho câu hỏi nhỏ 2 -->
                                <div class="mb-3 mt-2">
                                    <label class="form-label">Điểm số</label>
                                    <input type="number" class="form-control score-input" min="0" max="10" step="0.5" value="1">
                                </div>
                                <div>
                                    <label class="form-label">Đáp án</label>
                                    <div class="sub-answer-options">
                                        <div class="answer-option">
                                            <div class="d-flex align-items-center mb-2">
                                                <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_1" checked>
                                                <input type="text" class="form-control" placeholder="Đáp án A">
                                            </div>
                                        </div>
                                        <div class="answer-option">
                                            <div class="d-flex align-items-center mb-2">
                                                <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_1">
                                                <input type="text" class="form-control" placeholder="Đáp án B">
                                            </div>
                                        </div>
                                        <div class="answer-option">
                                            <div class="d-flex align-items-center mb-2">
                                                <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_1">
                                                <input type="text" class="form-control" placeholder="Đáp án C">
                                            </div>
                                        </div>
                                        <div class="answer-option">
                                            <div class="d-flex align-items-center mb-2">
                                                <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_1">
                                                <input type="text" class="form-control" placeholder="Đáp án D">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        `;
    }

    
    $(document).ready(function() {
        var addQuestionUrl = 'add_reading_question.html';
        var skillId = '';
        var skillName = '';
        var bankName = '';
        let questionCounter = 0;
        let currentEditId = null;

        // Show question-type section by default
        $('.content-section').hide();
        $('#add-question').show();
        $('.nav-link').removeClass('active');
        $('#menu-add-question').addClass('active');
        $('#submenu-question').removeClass('d-none');
        
        var questionTypes = []
        // thêm form theo type
        $.ajax({
            url: 'https://localhost:7001/api/skill/skill',
            type: 'GET',
            xhrFields: {
                withCredentials: true
            },
            success: function(response) {
                skillId = response.id
                console.log('response skill: ', response)
                skillName = response.name;
                $('#bank-name').text(response.questionBankName)
                $('#skill-name').text(response.name)
                console.log('Skill ID:', skillId);
                // get question type
                $.ajax({
                    url: `https://localhost:7001/api/questiontype/skill/${skillId}`,
                    type: 'GET',
                    xhrFields: { withCredentials : true},
                    success: function(response) {
                        console.log('Question Types:', response);
                        questionTypes = response;
                        // Clear existing options
                        $('#questionCategory').empty();
                        // Add new options from questionTypes
                        questionTypes.forEach(type => {
                            $('#questionCategory').append(`<option value="${type.id}_${type.isSingle}_${type.hasImage}">${type.name}</option>`);
                        });
                    
                        if(skillName === 'nghe') {
                            $('.audio-input').show();
                        }
        
                        function addQuestionForm(format, hasImage) {
                            if(format) {
                                    $('#questionList').prepend(createSingleFormHtml(hasImage, skillName));
                                    questionCounter++;
                            } else {
                                $('#questionList').prepend(createDoubleFormHtml(hasImage, skillName));
                                questionCounter++;
                            }
                            updateQuestionNumbers();
                        }
                        const selectedValue = $('#questionCategory').val();
                        const [id, isSingle, hasImage] = selectedValue.split('_');
                        //console.log('selectedValue', selectedValue);
                        //addQuestionForm(isSingle, hasImage);
                    },
                    error: function(error) {
                        console.error('Error loading question types:', error.responseText);
                    }
                })
            },
            error: function(error) {
                console.log('Error:', error.responseText);
                
            }
        });

        // Xử lý chọn loại câu hỏi
        $('#questionCategory').on('change', function() {
            $('#questionList').empty();
            questionCounter = 0; // Reset counter khi chọn loại câu hỏi mới
            $('#btn-add-question').prop('disabled', false); // Enable nút thêm câu hỏi khi chọn loại mới
        });

        // Xử lý nút thêm form nhập câu hỏi
        $('#btn-add-question').on('click', function() {
            const selectedValue = $('#questionCategory').val();
            if (!selectedValue) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Cảnh báo!',
                    text: 'Vui lòng chọn loại câu hỏi trước!'
                });
                return;
            }

            const [id, isSingle, hasImage] = selectedValue.split('_');
            
            // Tìm question type tương ứng
            const selectedType = questionTypes.find(type => type.id === id);
            if (selectedType) {
                questionCounter++; // Tăng counter khi thêm câu hỏi mới
                // Show form dựa vào isSingle
                if (selectedType.isSingle === true) {
                    $('#questionList').prepend(createSingleFormHtml(selectedType.hasImage, skillName));
                    // Hiển thị audio input nếu là kỹ năng nghe
                    if(skillName === 'nghe') {
                        $(`#singleQuestionAudio_${questionCounter-1}`).show();
                    }
                } else {
                    $('#questionList').prepend(createDoubleFormHtml(selectedType.hasImage, skillName));
                }
                updateQuestionNumbers(); // Cập nhật số thứ tự câu hỏi
            }
        });

        // Thêm xử lý submit form
        $('#questionForm').on('submit', function(e) {
            e.preventDefault();
            
            // Kiểm tra xem đã chọn loại câu hỏi chưa
            const selectedValue = $('#questionCategory').val();
            if (!selectedValue) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Cảnh báo!',
                    text: 'Vui lòng chọn loại câu hỏi trước!'
                });
                return;
            }
            
            // Reset tất cả viền đỏ trước khi validate
            resetAllBorders();
            
            // Validate trước khi lấy dữ liệu
            const validationResult = validateAllQuestions();
            if (!validationResult.isValid) {
                Swal.fire({
                    icon: 'error',
                    title: 'Lỗi!',
                    text: validationResult.message
                });
                return;
            }

            const questionsData = getAllQuestionsData();
            console.log('qdata', questionsData)
            console.log('Questions data to be sent:', questionsData);
            
            if (!questionsData || questionsData.length === 0) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Cảnh báo!',
                    text: 'Vui lòng thêm ít nhất một câu hỏi!'
                });
                return;
            }

            // Xử lý gửi danh sách câu hỏi
            const processQuestions = async () => {
                try {
                    const selectedValue = $('#questionCategory').val();
                    const [id, isSingle, hasImage] = selectedValue.split('_');
                    
                    // Tạo FormData
                    const formData = new FormData();
                    var apiUrl = '';
                    if(isSingle === 'true') {
                        apiUrl = 'https://localhost:7001/api/contentblock/single';
                        questionsData.forEach((q, i) => {
                            formData.append(`lists[${i}].TextContent`, q.TextContent);
                            formData.append(`lists[${i}].Level`, q.Level);
                            formData.append(`lists[${i}].QuestionTypeId`, q.QuestionTypeId);
                            formData.append(`lists[${i}].Score`, q.Score);
                            if (q.ImageFile) {
                                formData.append(`lists[${i}].ImageFile`, q.ImageFile);
                            }
                            if (q.AudioFile) {
                                formData.append(`lists[${i}].AudioFile`, q.AudioFile);
                            }

                            q.Answers.forEach((ans, j) => {
                                formData.append(`lists[${i}].Answers[${j}].Content`, ans.Content);
                                formData.append(`lists[${i}].Answers[${j}].IsCorrect`, ans.IsCorrect);
                            });
                        });
                    } else {
                        apiUrl = 'https://localhost:7001/api/contentblock/double';
                        questionsData.forEach((q, i) => {
                            formData.append(`lists[${i}].Content`, q.Content);
                            formData.append(`lists[${i}].Level`, q.Level);
                            formData.append(`lists[${i}].QuestionTypeId`, q.QuestionTypeId);
                            if (q.ImageFile) {
                                formData.append(`lists[${i}].ImageFile`, q.ImageFile);
                            }
                            if (q.AudioFile) {
                                formData.append(`lists[${i}].AudioFile`, q.AudioFile);
                            }
                            q.Questions.forEach((question, j) => {
                                formData.append(`lists[${i}].Questions[${j}].Content`, question.Content);
                                formData.append(`lists[${i}].Questions[${j}].Score`, question.Score);
                                question.Answers.forEach((ans, k) => {
                                    formData.append(`lists[${i}].Questions[${j}].Answers[${k}].Content`, ans.Content);
                                    formData.append(`lists[${i}].Questions[${j}].Answers[${k}].IsCorrect`, ans.IsCorrect);
                                });
                            });
                        });
                    }
                    // Gửi request
                    const response = await $.ajax({
                        url: apiUrl,
                        method: 'POST',
                        data: formData,
                        processData: false,
                        contentType: false,
                        xhrFields: { withCredentials: true },
                        success: function(response) {
                            console.log('Server response:', response);
                            Swal.fire({
                                icon: 'success',
                                title: 'Thành công!',
                                text: 'Đã lưu câu hỏi thành công!',
                                showConfirmButton: false,
                                timer: 1500
                            }).then(() => {
                                window.location.reload();
                            });
                        },
                        error: function(error) {
                            console.error('Server error:', error.responseText);
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi!',
                                text: 'Có lỗi xảy ra khi lưu câu hỏi. Vui lòng thử lại!'
                            });
                        }
                    });
                } catch (error) {
                    console.error('Error:', error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi!',
                        text: 'Có lỗi xảy ra khi lưu câu hỏi. Vui lòng thử lại!'
                    });
                }
            };

            // Thực thi xử lý
            processQuestions();
        });

        // Hàm lấy dữ liệu từ câu hỏi đơn
    function getSingleQuestionData(questionElement) {
        const selectedValue = $('#questionCategory').val();
        if (!selectedValue) {
            console.error('No question type selected');
            return null;
        }
        const [id, isSingle, hasImage] = selectedValue.split('_');
        var questionText = questionElement.find('.card-body textarea').first().val();
        if(!questionText) questionText = ''
        const score = parseFloat(questionElement.find('.score-input').val()) || 1;
        
        let imageFile = null;
        let audioFile = null;
        
        if(hasImage === 'true') {
            imageFile = questionElement.find(`#singleQuestionImage input[type="file"]`).prop('files')[0];
        }
        
        if(skillName === 'nghe') {
            audioFile = questionElement.find(`#singleQuestionAudio input[type="file"]`).prop('files')[0];
        }
        
        const answers = questionElement.find('.answer-option').map(function() {
            return {
                Content: $(this).find('input[type="text"]').val(),
                IsCorrect: $(this).find('input[type="radio"]').is(':checked')
            };
        }).get();
        //console.log('answer', answers)
        return {
            TextContent: questionText,
            Level: 1,
            Score: score,
            QuestionTypeId: id,
            ImageFile: imageFile,
            AudioFile: audioFile,
            Answers: answers
        };
    }

    // Hàm lấy dữ liệu từ câu hỏi kép
    function getDoubleQuestionData(questionElement) {
        const selectedValue = $('#questionCategory').val();
        if (!selectedValue) {
            console.error('No question type selected');
            return null;
        }
        const [id, isSingle, hasImage] = selectedValue.split('_');
        const passage = questionElement.find('.card-body textarea').first().val();
        var imageFile = null;
        var audioFile = null;
        if(hasImage === 'true') {
            imageFile = questionElement.find('#doubleQuestionImage input[type="file"]').prop('files')[0];
        }
        if(skillName === 'nghe') {
            audioFile = questionElement.find('#doubleQuestionAudio input[type="file"]').prop('files')[0];
        }
        const questions = questionElement.find('.card.mb-3').map(function() {
            const subQuestionElement = $(this);
            return {
                Content: subQuestionElement.find('input[type="text"]').first().val(),
                Score: parseFloat(subQuestionElement.find('.score-input').val()) || 1,
                Answers: subQuestionElement.find('.answer-option').map(function() {
                    return {
                        Content: $(this).find('input[type="text"]').val(),
                        IsCorrect: $(this).find('input[type="radio"]').is(':checked')
                    };
                }).get()
            };
        }).get();

        return {
            QuestionTypeId: id,
            Content: passage,
            Level: 1,
            ImageFile: imageFile,
            AudioFile: audioFile,
            Questions: questions
        };
    }

    // Hàm lấy tất cả dữ liệu câu hỏi
    function getAllQuestionsData() {
        const questions = [];
        const selectedValue = $('#questionCategory').val();
        if (!selectedValue) {
            console.error('No question type selected');
            return [];
        }
        const [id, isSingle, hasImage] = selectedValue.split('_');
        console.log('Selected question type:', { id, isSingle, hasImage });
        
        $('#questionList > div').each(function() {
            const questionElement = $(this);
            const questionType = questionElement.find('.card-header h5').text().trim();
            //console.log('Processing question type:', questionType);
            
            if (isSingle === 'true') {
                const questionData = getSingleQuestionData(questionElement);
                if (questionData) {
                    questions.push(questionData);
                }
            } else {
                const questionData = getDoubleQuestionData(questionElement);
                if (questionData) {
                    questions.push(questionData);
                }
            }
        });
        
        console.log('All questions data:', questions);
        return questions;
    }

    
    // Thêm xử lý khi người dùng thay đổi giá trị input
    $(document).on('input', '.answer-option input[type="text"]', function() {
        resetAllBorders();
        const validationResult = validateAllQuestions();
        if (!validationResult.isValid) {
            // Không hiển thị alert khi đang nhập
            console.log(validationResult.message);
        }
    });

    // Thêm xử lý khi người dùng thay đổi file
    $(document).on('change', '.answer-option input[type="file"]', function() {
        resetAllBorders();
        const validationResult = validateAllQuestions();
        if (!validationResult.isValid) {
            // Không hiển thị alert khi đang chọn file
            console.log(validationResult.message);
        }
    });
});


    // Hàm xem trước hình ảnh cho câu hỏi đơn
    function previewSingleImage(event, questionIndex) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $(`#singleImagePreview_${questionIndex}`).attr('src', e.target.result).show();
            }
            reader.readAsDataURL(file);
        }
    }

    // Hàm xem trước hình ảnh cho câu hỏi kép
    function previewDoubleImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#doubleImagePreview').attr('src', e.target.result).show();
            }
            reader.readAsDataURL(file);
        }
    }

    // Hàm xem trước âm thanh
    function previewAudio(event, questionIndex) {
        const file = event.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            $(`#audioPreview_${questionIndex}`).attr('src', url).show();
        }
    }

    // Hàm chuyển đổi loại nội dung câu hỏi nhỏ (text/ảnh)
    function toggleSubContentType(index) {
        const type = $(`input[name="subContentType${index}"]:checked`).val();
        $(`#subQuestionText${index}`).toggle(type === 'text');
        $(`#subQuestionImage${index}`).toggle(type === 'image');
    }

    // Hàm xem trước hình ảnh cho câu hỏi nhỏ
    function previewSubImage(event, index) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                $(`#subImagePreview${index}`).attr('src', e.target.result).show();
            }
            reader.readAsDataURL(file);
        }
    }

    // Thêm hàm xử lý xóa câu hỏi
    function deleteQuestion(button) {
        if (confirm('Bạn có chắc chắn muốn xóa câu hỏi này?')) {
            $(button).closest('.question-card').parent().remove();
            updateQuestionNumbers();
        }
    }

    // Thêm hàm cập nhật số thứ tự câu hỏi
    function updateQuestionNumbers() {
        $('.question-card').each(function(index) {
            $(this).find('.badge').text(`Câu ${index + 1}`);
        });
    }

    // Hàm kiểm tra đáp án trùng nhau trong câu hỏi đọc hiểu
    function validateSingleQuestion(questionElement) {
        const answerInputs = questionElement.find('.answer-option input[type="text"]');
        const answers = answerInputs.map(function() {
            return $(this).val().trim();
        }).get();
        
        // Reset viền đỏ
        answerInputs.closest('.answer-option').css('border-color', '');
        
        const duplicateMap = new Map();
        answers.forEach((answer, index) => {
            if (answer) {
                if (!duplicateMap.has(answer)) {
                    duplicateMap.set(answer, [index]);
                } else {
                    duplicateMap.get(answer).push(index);
                }
            }
        });

        let hasDuplicates = false;
        duplicateMap.forEach((indices, answer) => {
            if (indices.length > 1) {
                hasDuplicates = true;
                indices.forEach(index => {
                    answerInputs.eq(index).closest('.answer-option').css('border-color', 'red');
                });
            }
        });

        if (hasDuplicates) {
            return {
                isValid: false,
                message: 'Các đáp án không được trùng nhau'
            };
        }
        return { isValid: true };
    }

    // Hàm kiểm tra đáp án trùng nhau trong câu hỏi đọc chọn ý
    function validateDoubleQuestion(questionElement) {
        const subQuestions = questionElement.find('.card.mb-3');
        for (let i = 0; i < subQuestions.length; i++) {
            const subQuestion = $(subQuestions[i]);
            const answerInputs = subQuestion.find('.answer-option input[type="text"]');
            
            // Reset viền đỏ
            answerInputs.closest('.answer-option').css('border-color', '');
            
            const answers = answerInputs.map(function() {
                return $(this).val().trim();
            }).get();

            const duplicateMap = new Map();
            answers.forEach((answer, index) => {
                if (answer) {
                    if (!duplicateMap.has(answer)) {
                        duplicateMap.set(answer, [index]);
                    } else {
                        duplicateMap.get(answer).push(index);
                    }
                }
            });

            let hasDuplicates = false;
            duplicateMap.forEach((indices, answer) => {
                if (indices.length > 1) {
                    hasDuplicates = true;
                    indices.forEach(index => {
                        answerInputs.eq(index).closest('.answer-option').css('border-color', 'red');
                    });
                }
            });

            if (hasDuplicates) {
                return {
                    isValid: false,
                    message: `Câu hỏi nhỏ ${i + 1}: Các đáp án không được trùng nhau`
                };
            }
        }
        return { isValid: true };
    }

    // Thêm hàm reset viền đỏ cho tất cả câu hỏi
    function resetAllBorders() {
        $('.answer-option').css('border-color', '');
    }

    // Hàm validate tất cả câu hỏi
    function validateAllQuestions() {
        const questions = $('#questionList > div');
        if (questions.length === 0) {
            return { isValid: true }; // Không có câu hỏi nào thì return true
        }

        for (let i = 0; i < questions.length; i++) {
            const questionElement = $(questions[i]);
            const questionType = questionElement.find('.card-header h5').text().trim();
            let validationResult = { isValid: true }; // Mặc định là true

            if (questionType.includes('Câu hỏi đọc hiểu')) {
                validationResult = validateSingleQuestion(questionElement);
            } else if (questionType.includes('Câu hỏi đọc chọn ý')) {
                validationResult = validateDoubleQuestion(questionElement);
            }

            if (!validationResult.isValid) {
                return {
                    isValid: false,
                    message: `Câu hỏi ${i + 1}: ${validationResult.message}`
                };
            }
        }
        return { isValid: true };
    }
    </script>
</body>
</html>
