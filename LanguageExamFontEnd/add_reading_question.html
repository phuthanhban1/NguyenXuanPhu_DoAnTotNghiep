<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thêm câu hỏi</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .nav-pills .nav-link.active {
            background-color: #0d6efd;
        }
        .question-card {
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 1px solid #dee2e6;
            margin-bottom: 20px;
            background-color: #fff;
        }
        .question-card .card-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 15px 20px;
        }
        .question-card .card-body {
            padding: 20px;
        }
        .answer-option {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            background-color: #f8f9fa;
        }
        .answer-option:hover {
            border-color: #0d6efd;
            box-shadow: 0 2px 4px rgba(13, 110, 253, 0.1);
            background-color: #fff;
        }
        .excel-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .excel-upload-area:hover {
            border-color: #0d6efd;
            background-color: rgba(13, 110, 253, 0.05);
        }
        /* New styles for question list */
        #questionList {
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 15px;
            border: 1px solid #dee2e6;
        }
        .question-card {
            position: relative;
            overflow: hidden;
        }
        .question-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: #0d6efd;
        }
        .question-card .card-header h5 {
            color: #0d6efd;
            font-weight: 600;
        }
        .question-card .btn-danger {
            padding: 5px 10px;
            border-radius: 5px;
        }
        .question-card .form-check {
            margin-bottom: 15px;
        }
        .question-card .form-label {
            font-weight: 500;
            color: #495057;
        }
        .question-card textarea,
        .question-card input[type="text"] {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px;
        }
        .question-card textarea:focus,
        .question-card input[type="text"]:focus {
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-header bg-white py-3">
                        <h4 class="mb-0">Thêm câu hỏi mới</h4>
                    </div>
                    <div class="card-body">
                        <!-- Navigation Pills -->
                        <ul class="nav nav-pills mb-4" id="questionTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="manual-tab" data-bs-toggle="pill" data-bs-target="#manual" type="button">
                                    <i class="fas fa-keyboard me-2"></i>Nhập tay
                                </button>
                            </li>
                            
                        </ul>

                        <!-- Tab Content -->
                        <div class="tab-content" id="questionTabsContent">
                            <!-- Manual Input Tab -->
                            <div class="tab-pane fade show active" id="manual" role="tabpanel">
                                <form>
                                    <div class="mb-4">
                                        <label class="form-label">Loại câu hỏi</label>
                                        <select class="form-select" id="questionCategory" onchange="handleQuestionTypeChange()">
                                        </select>
                                    </div>

                                    <!-- Add Question Buttons -->
                                    <div class="mb-4">
                                        <button type="button" class="btn btn-primary" id="add-question">
                                            <i class="fas fa-plus me-2"></i>Thêm câu hỏi
                                        </button>
                                    </div>
                                    <div class="d-flex justify-content-end gap-2">
                                        <button type="button" class="btn btn-secondary">Hủy</button>
                                        <button type="submit" class="btn btn-primary">Lưu</button>
                                    </div>
                                    <!-- Question List -->
                                    <div id="questionList" class="mb-4">
                                    </div>

                                </form>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS and Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <script>
        let questionCounter = 0; // Thêm biến đếm số câu hỏi
        
        function createSingleFormHtml(hasImage = false) {
            return `
            <div id="singleQuestionForm">
                <div class="card question-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Câu hỏi đọc hiểu <span class="badge bg-primary">Câu ${questionCounter + 1}</span></h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteQuestion(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Thêm hình ảnh -->
                        <div id="singleQuestionImage" class="mt-2" ${!hasImage ? 'style="display:none;"' : ''}>
                            <label class="form-label">Hình ảnh câu hỏi</label>
                            <input type="file" accept="image/*" class="form-control" onchange="previewSingleImage(event)">
                            <img id="singleImagePreview" src="" alt="Xem trước ảnh" style="max-width:200px; margin-top:10px; display:none;">
                        </div>
                        <!-- Nội dung câu hỏi text -->
                        <div class="mb-3">
                            <label class="form-label">Nội dung câu hỏi</label>
                            <div id="singleQuestionText">
                                <textarea class="form-control" rows="4" placeholder="Nhập nội dung câu hỏi..."></textarea>
                            </div>
                        </div>
                        <!-- Âm thanh -->
                        <div id="singleQuestionAudio" style="display:none;" class="mt-3">
                            <label class="form-label">File âm thanh</label>
                            <input type="file" accept="audio/*" class="form-control" onchange="previewAudio(event)">
                            <audio id="audioPreview" controls style="display:none; margin-top:10px;"></audio>
                        </div>
                        <!-- Đáp án -->
                        <div class="mb-3">
                            <label class="form-label">Đáp án</label>
                            <div id="answerOptions">
                                <div class="answer-option">
                                    <div class="d-flex align-items-center mb-2">
                                        <input type="radio" class="form-check-input me-2" name="correctAnswer_${questionCounter}" checked>
                                        <input type="text" class="form-control" placeholder="Đáp án A">
                                    </div>
                                </div>
                                <div class="answer-option">
                                    <div class="d-flex align-items-center mb-2">
                                        <input type="radio" class="form-check-input me-2" name="correctAnswer_${questionCounter}">
                                        <input type="text" class="form-control" placeholder="Đáp án B">
                                    </div>
                                </div>
                                <div class="answer-option">
                                    <div class="d-flex align-items-center mb-2">
                                        <input type="radio" class="form-check-input me-2" name="correctAnswer_${questionCounter}">
                                        <input type="text" class="form-control" placeholder="Đáp án C">
                                    </div>
                                </div>
                                <div class="answer-option">
                                    <div class="d-flex align-items-center mb-2">
                                        <input type="radio" class="form-check-input me-2" name="correctAnswer_${questionCounter}">
                                        <input type="text" class="form-control" placeholder="Đáp án D">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        function createDoubleFormHtml(hasImage = false) {
            return `
            <div id="doubleQuestionForm">
                <div class="card question-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Câu hỏi đọc chọn ý <span class="badge bg-primary">Câu ${questionCounter + 1}</span></h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="deleteQuestion(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <!-- Đoạn văn -->
                        <div class="mb-4">
                            <label class="form-label">Đoạn văn</label>
                            <textarea class="form-control" rows="4" placeholder="Nhập đoạn văn..."></textarea>
                        </div>
                        <!-- Hình ảnh -->
                        <div id="doubleQuestionImage" class="mt-2" ${!hasImage ? 'style="display:none;"' : ''}>
                            <label class="form-label">Hình ảnh câu hỏi</label>
                            <input type="file" accept="image/*" class="form-control" onchange="previewDoubleImage(event)">
                            <img id="doubleImagePreview" src="" alt="Xem trước ảnh" style="max-width:200px; margin-top:10px; display:none;">
                        </div>
                        <!-- Âm thanh -->
                        <div id="doubleQuestionAudio" style="display:none;" class="mt-3">
                            <label class="form-label">File âm thanh</label>
                            <input type="file" accept="audio/*" class="form-control" onchange="previewAudio(event)">
                            <audio id="audioPreview" controls style="display:none; margin-top:10px;"></audio>
                        </div>
                        <!-- Câu hỏi nhỏ -->
                        <div id="subQuestions">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>Câu hỏi nhỏ 1</strong>
                                    </div>
                                    <div id="subQuestionText0">
                                        <input type="text" class="form-control" placeholder="Nhập nội dung câu hỏi nhỏ...">
                                    </div>
                                   
                                    <div>
                                        <label class="form-label">Đáp án</label>
                                        <div class="sub-answer-options">
                                            <div class="answer-option">
                                                <div class="d-flex align-items-center mb-2">
                                                    <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_0" checked>
                                                    <input type="text" class="form-control" placeholder="Đáp án A">
                                                </div>
                                            </div>
                                            <div class="answer-option">
                                                <div class="d-flex align-items-center mb-2">
                                                    <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_0">
                                                    <input type="text" class="form-control" placeholder="Đáp án B">
                                                </div>
                                            </div>
                                            <div class="answer-option">
                                                <div class="d-flex align-items-center mb-2">
                                                    <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_0">
                                                    <input type="text" class="form-control" placeholder="Đáp án C">
                                                </div>
                                            </div>
                                            <div class="answer-option">
                                                <div class="d-flex align-items-center mb-2">
                                                    <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_0">
                                                    <input type="text" class="form-control" placeholder="Đáp án D">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="subQuestions">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong>Câu hỏi nhỏ 2</strong>
                                    </div>
                                    <div id="subQuestionText1">
                                        <input type="text" class="form-control" placeholder="Nhập nội dung câu hỏi nhỏ...">
                                    </div>
                                    
                                    <div>
                                        <label class="form-label">Đáp án</label>
                                        <div class="sub-answer-options">
                                            <div class="answer-option">
                                                <div class="d-flex align-items-center mb-2">
                                                    <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_1" checked>
                                                    <input type="text" class="form-control" placeholder="Đáp án A">
                                                </div>
                                            </div>
                                            <div class="answer-option">
                                                <div class="d-flex align-items-center mb-2">
                                                    <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_1">
                                                    <input type="text" class="form-control" placeholder="Đáp án B">
                                                </div>
                                            </div>
                                            <div class="answer-option">
                                                <div class="d-flex align-items-center mb-2">
                                                    <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_1">
                                                    <input type="text" class="form-control" placeholder="Đáp án C">
                                                </div>
                                            </div>
                                            <div class="answer-option">
                                                <div class="d-flex align-items-center mb-2">
                                                    <input type="radio" class="form-check-input me-2" name="correctSubAnswer_${questionCounter}_1">
                                                    <input type="text" class="form-control" placeholder="Đáp án D">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
        }

        var readingDetail = [{ name: "câu đơn", format: 0, hasImage: false },
                            { name: "câu đơn hình ảnh", format: 0, hasImage: true },
                            { name: "câu kép", format: 1, hasImage: false },
                            { name: "câu kép hình ảnh", format: 1, hasImage: true }]; // câu hỏi kép
        $(document).ready(function() {
            const params = new URLSearchParams(window.location.search);
            const skill = params.get("skill");
            console.log(skill);
            if(skill === 'nghe') {
                $('#singleQuestionAudio').show();
            }
            $('#questionCategory').append(readingDetail.map(item => `<option value="${item.name}_${item.format}_${item.hasImage}">${item.name}</option>`));
            
            function addQuestionForm(format, hasImage) {
                switch(format) {
                    case '0':
                        $('#questionList').prepend(createSingleFormHtml(hasImage === 'true'));
                        questionCounter++;
                        break;
                    case '1':
                        $('#questionList').prepend(createDoubleFormHtml(hasImage === 'true'));
                        questionCounter++;
                        break;
                }
                updateQuestionNumbers();
            }
            const selectedValue = $('#questionCategory').val();
            const [name, format, hasImage] = selectedValue.split('_');
            addQuestionForm(format, hasImage);
            
            // Xử lý chọn loại câu hỏi
            $('#questionCategory').on('change', function() {
                $('#questionList').empty();
                const selectedValue = $(this).val();
                const [name, format, hasImage] = selectedValue.split('_');
                questionCounter = 0;
                // Show form based on format
                addQuestionForm(format, hasImage);
            });

            // Xử lý thêm câu hỏi
            $('#add-question').on('click', function() {
                const selectedValue = $('#questionCategory').val();
                const [name, format, hasImage] = selectedValue.split('_');
                questionCounter++;
                addQuestionForm(format, hasImage);
            });

            // Thêm xử lý submit form
            $('form').on('submit', function(e) {
                e.preventDefault();
                
                // Reset tất cả viền đỏ trước khi validate
                resetAllBorders();
                
                // Validate trước khi lấy dữ liệu
                const validationResult = validateAllQuestions();
                if (!validationResult.isValid) {
                    alert(validationResult.message);
                    return;
                }

                const questionsData = getAllQuestionsData();
                console.log('Questions Data:', JSON.stringify(questionsData, null, 2));
                
                // Kiểm tra dữ liệu trước khi gửi
                if (questionsData.length === 0) {
                    alert('Vui lòng thêm ít nhất một câu hỏi');
                    return;
                }

                // Xử lý từng câu hỏi và gửi lên server
                const processQuestions = async () => {
                    try {
                        for (const question of questionsData) {
                            const formData = new FormData();
                            alert('124')
                            // Thêm thông tin cơ bản của câu hỏi
                            formData.append('QuestionTypeId', '14a8ec89-601b-4826-cd4b-08dd8be985dd');
                            formData.append('Level', 1);
                            formData.append('Score', 2);                            
                            if (question.type === 'single') {
                                // Xử lý câu hỏi đơn
                                formData.append('TextContent', question.content);
                                
                                // Thêm hình ảnh nếu có
                                if (question.hasImage && question.image) {
                                    formData.append('ImageFile', question.image.file);
                                }
                                
                                
                                // Thêm đáp án
                                question.answers.forEach((answer, index) => {
                                    formData.append(`Answers[${index}][content]`, answer.text);
                                    formData.append(`Answers[${index}][isCorrect]`, answer.isCorrect);
                                });
                                
                                // Gửi câu hỏi đơn
                                await $.ajax({
                                    url: 'https://localhost:7001/api/contentblock/single',
                                    method: 'POST',
                                    data: formData,
                                    processData: false,
                                    contentType: false
                                });
                                
                            } else if (question.type === 'double') {
                                // Xử lý câu hỏi kép
                                formData.append('passage', question.passage);
                                
                                // Thêm hình ảnh nếu có
                                if (question.hasImage && question.image) {
                                    formData.append('image', question.image.file);
                                }
                                
                                // Thêm câu hỏi nhỏ và đáp án
                                question.subQuestions.forEach((subQuestion, subIndex) => {
                                    formData.append(`subQuestions[${subIndex}][question]`, subQuestion.question);
                                    
                                    subQuestion.answers.forEach((answer, ansIndex) => {
                                        formData.append(`subQuestions[${subIndex}][answers][${ansIndex}][text]`, answer.text);
                                        formData.append(`subQuestions[${subIndex}][answers][${ansIndex}][isCorrect]`, answer.isCorrect);
                                    });
                                });
                                
                                // Gửi câu hỏi kép
                                await $.ajax({
                                    url: '/api/questions/double',
                                    method: 'POST',
                                    data: formData,
                                    processData: false,
                                    contentType: false
                                });
                            }
                        }
                        
                        alert('Lưu câu hỏi thành công');
                        window.location.href = '/questions'; // Chuyển hướng sau khi lưu thành công
                        
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Có lỗi xảy ra khi lưu câu hỏi');
                    }
                };

                // Thực thi xử lý
                processQuestions();
            });

            // Thêm xử lý khi người dùng thay đổi giá trị input
            $(document).on('input', '.answer-option input[type="text"]', function() {
                resetAllBorders();
                const validationResult = validateAllQuestions();
                if (!validationResult.isValid) {
                    // Không hiển thị alert khi đang nhập
                    console.log(validationResult.message);
                }
            });

            // Thêm xử lý khi người dùng thay đổi file
            $(document).on('change', '.answer-option input[type="file"]', function() {
                resetAllBorders();
                const validationResult = validateAllQuestions();
                if (!validationResult.isValid) {
                    // Không hiển thị alert khi đang chọn file
                    console.log(validationResult.message);
                }
            });
        });

        // Hàm xử lý hiển thị/ẩn hình ảnh cho câu hỏi đơn
        function toggleSingleImage() {
            const hasImage = $('#hasSingleImage').is(':checked');
            $('#singleQuestionImage').toggle(hasImage);
        }

        // Hàm xử lý hiển thị/ẩn hình ảnh cho câu hỏi kép
        function toggleDoubleImage() {
            const hasImage = $('#hasDoubleImage').is(':checked');
            $('#doubleQuestionImage').toggle(hasImage);
        }

        // Hàm xem trước hình ảnh cho câu hỏi đơn
        function previewSingleImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#singleImagePreview').attr('src', e.target.result).show();
                }
                reader.readAsDataURL(file);
            }
        }

        // Hàm xem trước hình ảnh cho câu hỏi kép
        function previewDoubleImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $('#doubleImagePreview').attr('src', e.target.result).show();
                }
                reader.readAsDataURL(file);
            }
        }

        // Hàm xem trước âm thanh
        function previewAudio(event) {
            const file = event.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                $('#audioPreview').attr('src', url).show();
            }
        }

        // Hàm chuyển đổi loại nội dung câu hỏi nhỏ (text/ảnh)
        function toggleSubContentType(index) {
            const type = $(`input[name="subContentType${index}"]:checked`).val();
            $(`#subQuestionText${index}`).toggle(type === 'text');
            $(`#subQuestionImage${index}`).toggle(type === 'image');
        }

        // Hàm xem trước hình ảnh cho câu hỏi nhỏ
        function previewSubImage(event, index) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    $(`#subImagePreview${index}`).attr('src', e.target.result).show();
                }
                reader.readAsDataURL(file);
            }
        }

        // Thêm hàm xử lý xóa câu hỏi
        function deleteQuestion(button) {
            if (confirm('Bạn có chắc chắn muốn xóa câu hỏi này?')) {
                $(button).closest('.question-card').parent().remove();
                updateQuestionNumbers();
            }
        }

        // Thêm hàm cập nhật số thứ tự câu hỏi
        function updateQuestionNumbers() {
            $('.question-card').each(function(index) {
                $(this).find('.badge').text(`Câu ${index + 1}`);
            });
        }

        // Hàm lấy dữ liệu từ câu hỏi đọc hiểu
        function getSingleQuestionData(questionElement) {
            const questionText = questionElement.find('.card-body textarea').first().val();
            const imageFile = questionElement.find('#singleQuestionImage input[type="file"]').prop('files')[0];
            const audioFile = questionElement.find('#singleQuestionAudio input[type="file"]').prop('files')[0];
            const answers = questionElement.find('.answer-option').map(function() {
                return {
                    text: $(this).find('input[type="text"]').val(),
                    isCorrect: $(this).find('input[type="radio"]').is(':checked')
                };
            }).get();

            const formData = new FormData();
            if (imageFile) {
                formData.append('image', imageFile);
            }
            if (audioFile) {
                formData.append('audio', audioFile);
            }

            return {
                type: 'single',
                questionNumber: questionElement.find('.badge').text().trim(),
                content: questionText,
                hasImage: imageFile !== undefined,
                image: imageFile ? {
                    name: imageFile.name,
                    type: imageFile.type,
                    size: imageFile.size,
                    file: imageFile
                } : null,
                hasAudio: audioFile !== undefined,
                audio: audioFile ? {
                    name: audioFile.name,
                    type: audioFile.type,
                    size: audioFile.size,
                    file: audioFile
                } : null,
                answers: answers
            };
        }

        // Hàm lấy dữ liệu từ câu hỏi đọc chọn ý
        function getDoubleQuestionData(questionElement) {
            const passage = questionElement.find('.card-body textarea').first().val();
            const imageFile = questionElement.find('#doubleQuestionImage input[type="file"]').prop('files')[0];
            const audioFile = questionElement.find('#doubleQuestionAudio input[type="file"]').prop('files')[0];
            const subQuestions = questionElement.find('.card.mb-3').map(function() {
                const subQuestionElement = $(this);
                const subImageFile = subQuestionElement.find('input[type="file"][accept="image/*"]').prop('files')[0];
                return {
                    question: subQuestionElement.find('input[type="text"]').first().val(),
                    hasImage: subImageFile !== undefined,
                    image: subImageFile ? {
                        name: subImageFile.name,
                        type: subImageFile.type,
                        size: subImageFile.size,
                        file: subImageFile
                    } : null,
                    answers: subQuestionElement.find('.answer-option').map(function() {
                        return {
                            text: $(this).find('input[type="text"]').val(),
                            isCorrect: $(this).find('input[type="radio"]').is(':checked')
                        };
                    }).get()
                };
            }).get();

            return {
                type: 'double',
                questionNumber: questionElement.find('.badge').text().trim(),
                passage: passage,
                hasImage: imageFile !== undefined,
                image: imageFile ? {
                    name: imageFile.name,
                    type: imageFile.type,
                    size: imageFile.size,
                    file: imageFile
                } : null,
                hasAudio: audioFile !== undefined,
                audio: audioFile ? {
                    name: audioFile.name,
                    type: audioFile.type,
                    size: audioFile.size,
                    file: audioFile
                } : null,
                subQuestions: subQuestions
            };
        }

        // Hàm lấy tất cả dữ liệu câu hỏi
        function getAllQuestionsData() {
            const questions = [];
            $('#questionList > div').each(function() {
                const questionElement = $(this);
                const questionType = questionElement.find('.card-header h5').text().trim();
                
                if (questionType.includes('Câu hỏi đọc hiểu')) {
                    questions.push(getSingleQuestionData(questionElement));
                } else if (questionType.includes('Câu hỏi đọc chọn ý')) {
                    questions.push(getDoubleQuestionData(questionElement));
                }
            });
            return questions;
        }

        // Hàm kiểm tra đáp án trùng nhau trong câu hỏi đọc hiểu
        function validateSingleQuestion(questionElement) {
            const answerInputs = questionElement.find('.answer-option input[type="text"]');
            const answers = answerInputs.map(function() {
                return $(this).val().trim();
            }).get();
            
            // Reset viền đỏ
            answerInputs.closest('.answer-option').css('border-color', '');
            
            const duplicateMap = new Map();
            answers.forEach((answer, index) => {
                if (answer) {
                    if (!duplicateMap.has(answer)) {
                        duplicateMap.set(answer, [index]);
                    } else {
                        duplicateMap.get(answer).push(index);
                    }
                }
            });

            let hasDuplicates = false;
            duplicateMap.forEach((indices, answer) => {
                if (indices.length > 1) {
                    hasDuplicates = true;
                    indices.forEach(index => {
                        answerInputs.eq(index).closest('.answer-option').css('border-color', 'red');
                    });
                }
            });

            if (hasDuplicates) {
                return {
                    isValid: false,
                    message: 'Các đáp án không được trùng nhau'
                };
            }
            return { isValid: true };
        }

        // Hàm kiểm tra đáp án trùng nhau trong câu hỏi đọc chọn ý
        function validateDoubleQuestion(questionElement) {
            const subQuestions = questionElement.find('.card.mb-3');
            for (let i = 0; i < subQuestions.length; i++) {
                const subQuestion = $(subQuestions[i]);
                const answerInputs = subQuestion.find('.answer-option input[type="text"]');
                
                // Reset viền đỏ
                answerInputs.closest('.answer-option').css('border-color', '');
                
                const answers = answerInputs.map(function() {
                    return $(this).val().trim();
                }).get();

                const duplicateMap = new Map();
                answers.forEach((answer, index) => {
                    if (answer) {
                        if (!duplicateMap.has(answer)) {
                            duplicateMap.set(answer, [index]);
                        } else {
                            duplicateMap.get(answer).push(index);
                        }
                    }
                });

                let hasDuplicates = false;
                duplicateMap.forEach((indices, answer) => {
                    if (indices.length > 1) {
                        hasDuplicates = true;
                        indices.forEach(index => {
                            answerInputs.eq(index).closest('.answer-option').css('border-color', 'red');
                        });
                    }
                });

                if (hasDuplicates) {
                    return {
                        isValid: false,
                        message: `Câu hỏi nhỏ ${i + 1}: Các đáp án không được trùng nhau`
                    };
                }
            }
            return { isValid: true };
        }

        // Thêm hàm reset viền đỏ cho tất cả câu hỏi
        function resetAllBorders() {
            $('.answer-option').css('border-color', '');
        }

        // Hàm validate tất cả câu hỏi
        function validateAllQuestions() {
            const questions = $('#questionList > div');
            if (questions.length === 0) {
                return { isValid: true }; // Không có câu hỏi nào thì return true
            }

            for (let i = 0; i < questions.length; i++) {
                const questionElement = $(questions[i]);
                const questionType = questionElement.find('.card-header h5').text().trim();
                let validationResult = { isValid: true }; // Mặc định là true

                if (questionType.includes('Câu hỏi đọc hiểu')) {
                    validationResult = validateSingleQuestion(questionElement);
                } else if (questionType.includes('Câu hỏi đọc chọn ý')) {
                    validationResult = validateDoubleQuestion(questionElement);
                }

                if (!validationResult.isValid) {
                    return {
                        isValid: false,
                        message: `Câu hỏi ${i + 1}: ${validationResult.message}`
                    };
                }
            }
            return { isValid: true };
        }
    </script>
</body>
</html>
